<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BookMarker</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --ink: #1a1208;
  --parchment: #f5edd6;
  --parchment-dark: #e8d9b8;
  --amber: #c8860a;
  --amber-light: #e9a82a;
  --rust: #8b3a1a;
  --sage: #4a6741;
  --shadow: rgba(26,18,8,0.15);
  --paper: #faf5e9;
  --streak-color: #e05a1b;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'EB Garamond', serif;
  background: var(--ink);
  color: var(--ink);
  min-height: 100vh;
  background-image: radial-gradient(ellipse at 20% 50%, rgba(200,134,10,0.07) 0%, transparent 60%),
                    radial-gradient(ellipse at 80% 20%, rgba(139,58,26,0.05) 0%, transparent 50%);
}

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.top-bar { position:sticky; top:0; z-index:300; background:var(--ink); }
nav {
  display:flex; align-items:center; justify-content:space-between;
  padding:0.7rem 1.2rem; border-bottom:1px solid rgba(200,134,10,0.25); gap:0.8rem;
}
.nav-brand {
  font-family:'Playfair Display',serif; font-size:1.15rem;
  color:var(--amber-light); font-style:italic; white-space:nowrap; flex-shrink:0;
}
.nav-brand em { font-style:normal; color:var(--parchment); opacity:0.35; font-size:0.8rem; margin-right:0.25rem; }
.nav-tabs { display:flex; gap:0.2rem; }
.nav-tab {
  font-family:'EB Garamond',serif; font-size:0.8rem; letter-spacing:0.05em;
  padding:0.35rem 0.8rem; border:1px solid transparent; border-radius:2px;
  cursor:pointer; transition:all 0.2s; background:none; color:var(--parchment);
  opacity:0.5; text-transform:uppercase; white-space:nowrap;
}
.nav-tab.active { border-color:var(--amber); color:var(--amber-light); opacity:1; background:rgba(200,134,10,0.09); }
.nav-tab:hover:not(.active) { opacity:0.85; }

/* ‚îÄ‚îÄ STREAK BANNER ‚îÄ‚îÄ */
.streak-banner {
  display:flex; align-items:center; justify-content:space-between;
  padding:0.5rem 1.2rem; background:rgba(224,90,27,0.07);
  border-bottom:1px solid rgba(224,90,27,0.15); gap:0.8rem; flex-wrap:wrap;
}
.streak-left { display:flex; align-items:center; gap:0.6rem; }
.streak-fire { font-size:1.45rem; line-height:1; }
.streak-num { font-family:'Playfair Display',serif; font-size:1.45rem; color:var(--streak-color); line-height:1; }
.streak-info .lbl { font-size:0.68rem; letter-spacing:0.09em; text-transform:uppercase; color:rgba(245,237,214,0.45); display:block; }
.streak-info .msg { font-size:0.82rem; color:rgba(245,237,214,0.6); font-style:italic; }
.streak-right { display:flex; gap:0.4rem; align-items:center; flex-shrink:0; }
.streak-logged { font-size:0.78rem; color:var(--amber-light); opacity:0.85; font-style:italic; }

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page { display:none; }
.page.active { display:block; }
.page-inner { padding:1.5rem 1rem; max-width:980px; margin:0 auto; }
@media(min-width:640px){ .page-inner { padding:2rem 1.5rem; } }

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; gap:0.5rem; }
.section-title {
  font-family:'Playfair Display',serif; font-size:1.1rem; color:var(--parchment);
  display:flex; align-items:center; gap:0.5rem;
}
.section-title::after { content:''; display:block; width:40px; height:1px; background:rgba(200,134,10,0.4); }

/* ‚îÄ‚îÄ BOOK TABS ‚îÄ‚îÄ */
.book-shelf {
  display:flex; gap:0.4rem; flex-wrap:wrap; align-items:center; margin-bottom:1.2rem;
}
.book-tab {
  font-family:'EB Garamond',serif; font-size:0.88rem;
  padding:0.35rem 0.9rem 0.35rem 0.7rem;
  border-radius:3px 3px 0 0; border:1.5px solid var(--parchment-dark); border-bottom:none;
  background:rgba(250,245,233,0.55); color:#888; cursor:pointer; transition:all 0.18s;
  display:flex; align-items:center; gap:0.35rem; white-space:nowrap;
  max-width:170px; overflow:hidden; text-overflow:ellipsis;
}
.book-tab .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
.book-tab.active { background:var(--paper); color:var(--ink); font-weight:500; z-index:1; }
.book-tab:hover:not(.active) { background:rgba(250,245,233,0.85); color:var(--ink); }
.book-tab .xt {
  margin-left:0.15rem; font-size:0.68rem; color:#bbb;
  cursor:pointer; padding:0 0.1rem; flex-shrink:0; transition:color 0.15s;
}
.book-tab .xt:hover { color:var(--rust); }
.add-book-tab {
  font-size:1.25rem; width:30px; height:30px; border-radius:50%;
  border:1.5px dashed rgba(200,134,10,0.5); background:none; color:var(--amber);
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:all 0.18s; flex-shrink:0; line-height:1;
}
.add-book-tab:hover { background:rgba(200,134,10,0.1); border-color:var(--amber); }

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card {
  background:var(--paper); border-radius:4px; padding:1.3rem;
  margin-bottom:1.1rem;
  box-shadow:0 3px 18px var(--shadow), inset 0 1px 0 rgba(255,255,255,0.65);
  position:relative;
}
.card::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:3px;
  border-radius:4px 0 0 4px; background:linear-gradient(to bottom,var(--amber),var(--rust));
}
.card h2 {
  font-family:'Playfair Display',serif; font-size:1.1rem; color:var(--rust);
  margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem;
}
.card h2::after { content:''; flex:1; height:1px; background:var(--parchment-dark); }

/* ‚îÄ‚îÄ ADD PANEL ‚îÄ‚îÄ */
.add-panel {
  background:var(--paper); border:1.5px solid var(--parchment-dark);
  border-radius:4px; margin-bottom:1.2rem; overflow:hidden; box-shadow:0 2px 12px var(--shadow);
}
.add-panel-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:0.65rem 1.1rem; cursor:pointer; user-select:none;
}
.add-panel-header:hover { background:rgba(200,134,10,0.04); }
.add-panel-title { font-family:'Playfair Display',serif; font-size:0.98rem; color:var(--rust); }
.add-panel-arrow { color:var(--amber); font-size:0.9rem; transition:transform 0.2s; }
.add-panel-body {
  padding:1.3rem; display:none; border-top:1px solid var(--parchment-dark);
  animation:slideDown 0.22s ease;
}
.add-panel-body.open { display:block; }
@keyframes slideDown { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:none} }

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
input[type="text"],input[type="number"],input[type="date"],select,textarea {
  font-family:'EB Garamond',serif; font-size:0.98rem; padding:0.55rem 0.8rem;
  border:1.5px solid var(--parchment-dark); border-radius:3px;
  background:var(--parchment); color:var(--ink); transition:border-color 0.2s; outline:none; width:100%;
}
input:focus,select:focus,textarea:focus { border-color:var(--amber); }
textarea { resize:vertical; min-height:60px; }
.form-group label {
  display:block; font-size:0.75rem; letter-spacing:0.08em;
  text-transform:uppercase; color:var(--rust); margin-bottom:0.28rem;
}
.fg2 { display:grid; grid-template-columns:1fr 1fr; gap:0.7rem; }
.fg3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:0.7rem; }
@media(max-width:540px){ .fg2,.fg3 { grid-template-columns:1fr; } }
@media(max-width:700px){ .fg3 { grid-template-columns:1fr 1fr; } }
.form-row { display:flex; gap:0.5rem; justify-content:flex-end; margin-top:0.7rem; flex-wrap:wrap; }
.search-row { display:flex; gap:0.5rem; }
.search-row input { flex:1; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  font-family:'EB Garamond',serif; font-size:0.93rem; letter-spacing:0.03em;
  padding:0.5rem 1.1rem; border:none; border-radius:3px; cursor:pointer;
  transition:all 0.18s; white-space:nowrap;
}
.btn-primary { background:var(--amber); color:#fff; }
.btn-primary:hover { background:var(--amber-light); }
.btn-ghost { background:transparent; border:1.5px solid var(--parchment-dark); color:var(--ink); opacity:0.7; }
.btn-ghost:hover { opacity:1; border-color:var(--amber); }
.btn-sm { padding:0.28rem 0.7rem; font-size:0.82rem; }
.btn-ink { background:rgba(26,18,8,0.08); border:1.5px solid rgba(200,134,10,0.3); color:var(--parchment); font-size:0.79rem; padding:0.3rem 0.72rem; }
.btn-ink:hover { background:rgba(200,134,10,0.15); }

/* ‚îÄ‚îÄ MODE TOGGLE ‚îÄ‚îÄ */
.mode-toggle {
  display:flex; border:1.5px solid var(--parchment-dark); border-radius:3px; overflow:hidden; margin-bottom:0.8rem;
}
.mode-toggle button {
  flex:1; font-family:'EB Garamond',serif; font-size:0.85rem;
  padding:0.42rem 0.5rem; border:none; background:var(--parchment); color:#999; cursor:pointer; transition:all 0.18s;
}
.mode-toggle button.active { background:var(--amber); color:#fff; }

/* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
#search-results { margin-top:0.7rem; display:none; max-height:260px; overflow-y:auto; }
.book-result {
  display:flex; gap:0.7rem; align-items:flex-start;
  padding:0.6rem; border:1.5px solid var(--parchment-dark); border-radius:3px;
  margin-bottom:0.4rem; cursor:pointer; transition:all 0.18s; background:var(--parchment);
}
.book-result:hover { border-color:var(--amber); background:#fff; transform:translateX(2px); }
.book-result img { width:34px; height:48px; object-fit:cover; border-radius:2px; flex-shrink:0; box-shadow:1px 1px 4px var(--shadow); }
.book-result-info { flex:1; min-width:0; }
.book-result-info strong { font-family:'Playfair Display',serif; font-size:0.92rem; display:block; }
.book-result-info small { color:#777; font-size:0.82rem; font-style:italic; }
.book-result-pp { font-size:0.8rem; color:var(--rust); font-style:italic; white-space:nowrap; }
.search-status { font-style:italic; color:#999; font-size:0.86rem; margin-top:0.4rem; min-height:1rem; }
.info-box { background:#fff8ee; border:1.5px solid #f0c97a; border-radius:3px; padding:0.8rem 1rem; font-size:0.87rem; color:#7a4f00; line-height:1.55; margin-top:0.5rem; }

/* ‚îÄ‚îÄ BOOK DETAIL ‚îÄ‚îÄ */
.book-detail { display:flex; gap:1rem; align-items:flex-start; flex-wrap:wrap; }
.book-cover { width:54px; height:76px; object-fit:cover; border-radius:2px; box-shadow:2px 3px 8px var(--shadow); flex-shrink:0; }
.book-cover-ph { width:54px; height:76px; border-radius:2px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:1.4rem; background:var(--parchment-dark); }
.book-detail-info { flex:1; min-width:0; }
.book-detail-author { color:#888; font-style:italic; font-size:0.88rem; margin-bottom:0.6rem; }
.stats-row { display:grid; grid-template-columns:repeat(3,1fr); gap:0.65rem; margin:0.8rem 0; }
@media(max-width:400px){ .stats-row { grid-template-columns:1fr 1fr; } }
.stat-box {
  background:rgba(250,245,233,0.7); border:1px solid var(--parchment-dark);
  border-radius:3px; padding:0.75rem 0.5rem; text-align:center; position:relative; overflow:hidden;
}
.stat-box::after { content:''; position:absolute; bottom:0; left:0; right:0; height:2px; background:linear-gradient(to right,var(--amber),var(--rust)); }
.stat-box .sv { font-family:'Playfair Display',serif; font-size:1.55rem; color:var(--rust); line-height:1; display:block; }
.stat-box .sl { font-size:0.7rem; letter-spacing:0.06em; text-transform:uppercase; color:#999; margin-top:0.18rem; }
.prog-wrap { background:var(--parchment-dark); border-radius:100px; height:8px; overflow:hidden; }
.prog-fill { height:100%; border-radius:100px; transition:width 0.8s ease; }
.prog-label { display:flex; justify-content:space-between; font-size:0.76rem; color:#aaa; margin-bottom:0.22rem; }

/* ‚îÄ‚îÄ LOG ‚îÄ‚îÄ */
.log-row { display:flex; gap:0.6rem; align-items:flex-end; flex-wrap:wrap; }
.log-row .form-group { flex:1; min-width:110px; }

/* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
.chart-wrap { position:relative; height:175px; margin-top:0.5rem; }

/* ‚îÄ‚îÄ COMBINED SCHEDULE ‚îÄ‚îÄ */
.schedule-day {
  margin-bottom:1rem; border-radius:4px; overflow:hidden;
  border:1px solid var(--parchment-dark);
}
.sday-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:0.5rem 0.9rem;
  background:linear-gradient(to right,rgba(200,134,10,0.09),rgba(139,58,26,0.04));
  border-bottom:1px solid var(--parchment-dark);
}
.sday-date {
  font-family:'Playfair Display',serif; font-size:0.98rem; color:var(--rust);
  display:flex; align-items:baseline; gap:0.4rem;
}
.sday-date .dn { font-family:'EB Garamond',serif; font-size:0.8rem; color:#aaa; font-style:italic; }
.sday-date .tb { font-family:'EB Garamond',serif; font-size:0.7rem; background:var(--amber); color:#fff; padding:0.04rem 0.38rem; border-radius:2px; font-style:normal; }
.sday-total { font-size:0.78rem; color:#aaa; font-style:italic; }
.sday-books { padding:0.3rem 0; }
.sbook-row {
  display:flex; align-items:center; gap:0.55rem; padding:0.4rem 0.9rem;
  border-bottom:1px dashed rgba(232,217,184,0.6); transition:background 0.15s;
}
.sbook-row:last-child { border-bottom:none; }
.sbook-row:hover { background:rgba(200,134,10,0.04); }
.sbook-row.snz { opacity:0.38; }
.sdot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
.stitle { font-family:'Playfair Display',serif; font-size:0.9rem; flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.spages { font-size:0.84rem; color:var(--rust); font-style:italic; white-space:nowrap; }
.snz-btn {
  background:none; border:1px solid var(--parchment-dark); border-radius:2px;
  color:#bbb; cursor:pointer; font-size:0.7rem; padding:0.08rem 0.38rem;
  font-family:'EB Garamond',serif; white-space:nowrap; transition:all 0.15s;
}
.snz-btn:hover { border-color:var(--amber); color:var(--amber); }
.snz-btn.on { background:rgba(200,134,10,0.07); border-color:var(--amber); color:var(--amber); }

/* check button in schedule */
.check-btn {
  width:20px; height:20px; border-radius:50%; border:1.5px solid #d5c9b0;
  background:none; cursor:pointer; flex-shrink:0; font-size:0.6rem;
  color:#ccc; display:flex; align-items:center; justify-content:center;
  transition:all 0.15s; line-height:1; padding:0;
}
.check-btn:hover { border-color:var(--sage); color:var(--sage); background:rgba(74,103,65,0.08); }
.check-btn.ck { border-color:var(--sage); background:var(--sage); color:#fff; }

/* done row in schedule - struck through and dimmed */
.sbook-row.done-row { opacity:0.42; }
.sbook-row.done-row .stitle { text-decoration:line-through; text-decoration-color:var(--sage); }
.sbook-row.done-row .spages { color:var(--sage); font-style:normal; }

/* today's reading summary in book detail */
.today-row {
  display:flex; align-items:center; justify-content:space-between;
  background:rgba(74,103,65,0.06); border:1px solid rgba(74,103,65,0.18);
  border-radius:3px; padding:0.42rem 0.7rem; margin-top:0.65rem;
  gap:0.5rem; flex-wrap:wrap;
}
.today-row.done-bg { background:rgba(74,103,65,0.11); border-color:rgba(74,103,65,0.3); }
.today-row .tlabel { font-size:0.82rem; color:var(--sage); font-style:italic; }
.today-row .tlabel strong { font-style:normal; }

/* ‚îÄ‚îÄ DONE / CHECK STATE ‚îÄ‚îÄ */
.sbook-row.done {
  opacity: 0.42;
  text-decoration: line-through;
  text-decoration-color: var(--sage);
}
.sbook-row.done .spages { text-decoration: none; color: var(--sage); font-style: normal; }
.check-btn {
  background: none;
  border: 1.5px solid var(--parchment-dark);
  border-radius: 50%;
  width: 20px; height: 20px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; flex-shrink: 0;
  font-size: 0.65rem; color: #ccc;
  transition: all 0.15s;
  line-height: 1;
}
.check-btn:hover { border-color: var(--sage); color: var(--sage); background: rgba(74,103,65,0.08); }
.check-btn.done { border-color: var(--sage); background: var(--sage); color: #fff; }

/* today's reading summary in book detail */
.today-reading-row {
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(74,103,65,0.06); border: 1px solid rgba(74,103,65,0.18);
  border-radius: 3px; padding: 0.45rem 0.7rem; margin-top: 0.65rem; gap: 0.5rem; flex-wrap: wrap;
}
.today-reading-row.done-row {
  background: rgba(74,103,65,0.1); border-color: rgba(74,103,65,0.3);
}
.today-label { font-size: 0.82rem; color: var(--sage); font-style: italic; }
.today-label strong { font-style: normal; }

/* ‚îÄ‚îÄ LIBRARY ‚îÄ‚îÄ */
.lib-filters { display:flex; gap:0.4rem; flex-wrap:wrap; margin-bottom:0.9rem; align-items:center; }
.lib-filters input[type="text"] { flex:1; min-width:120px; max-width:190px; }
.filter-chip {
  font-family:'EB Garamond',serif; font-size:0.79rem;
  padding:0.26rem 0.72rem; border:1.5px solid var(--parchment-dark);
  border-radius:100px; cursor:pointer; background:var(--parchment); color:var(--ink); transition:all 0.15s; white-space:nowrap;
}
.filter-chip.active { background:var(--amber); border-color:var(--amber); color:#fff; }
.library-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(225px,1fr)); gap:0.85rem; }
.library-card {
  background:var(--paper); border-radius:4px; padding:1.05rem 0.95rem 0.8rem;
  box-shadow:0 2px 10px var(--shadow); position:relative;
  border-top:3px solid var(--amber); transition:transform 0.18s,box-shadow 0.18s;
}
.library-card:hover { transform:translateY(-2px); box-shadow:0 5px 18px var(--shadow); }
.library-card.editing { border-top-color:var(--rust); background:#fffdf5; }
.lc-title { font-family:'Playfair Display',serif; font-size:0.98rem; line-height:1.3; margin-bottom:0.1rem; padding-right:1.3rem; }
.lc-author { font-style:italic; color:#888; font-size:0.83rem; margin-bottom:0.45rem; }
.lc-meta { display:flex; gap:0.3rem; flex-wrap:wrap; margin-bottom:0.45rem; }
.lc-location { font-size:0.83rem; color:var(--sage); display:flex; align-items:flex-start; gap:0.22rem; margin-bottom:0.32rem; }
.lc-due { font-size:0.81rem; color:var(--rust); display:flex; align-items:center; gap:0.22rem; margin-bottom:0.32rem; }
.lc-due.overdue { color:#c0392b; font-weight:500; }
.lc-notes { font-size:0.81rem; color:#666; font-style:italic; border-top:1px dashed var(--parchment-dark); padding-top:0.42rem; margin-top:0.28rem; line-height:1.45; }
.lc-actions { display:flex; gap:0.32rem; margin-top:0.55rem; flex-wrap:wrap; }
.lc-delete { position:absolute; top:0.55rem; right:0.62rem; background:none; border:none; color:#ccc; cursor:pointer; font-size:0.88rem; transition:color 0.15s; }
.lc-delete:hover { color:var(--rust); }
.status-badge { display:inline-block; font-size:0.69rem; padding:0.07rem 0.46rem; border-radius:100px; letter-spacing:0.05em; }
.badge-unread { background:#e8d9b8; color:var(--rust); }
.badge-reading { background:rgba(200,134,10,0.14); color:var(--amber); }
.badge-finished { background:rgba(74,103,65,0.11); color:var(--sage); }
.edit-form { margin-top:0.65rem; display:flex; flex-direction:column; gap:0.52rem; }
.empty-state { text-align:center; padding:3rem; color:#aaa; font-style:italic; font-size:1rem; grid-column:1/-1; }

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
@keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:none} }
.fu { animation:fadeUp 0.5s ease both; }
.spinner { width:13px; height:13px; border:2px solid rgba(200,134,10,0.3); border-top-color:var(--amber); border-radius:50%; animation:spin 0.65s linear infinite; display:inline-block; vertical-align:middle; margin-right:0.3rem; }
@keyframes spin { to{transform:rotate(360deg)} }

/* book color palette */
.dc0{background:#c8860a}.dc1{background:#8b3a1a}.dc2{background:#4a6741}
.dc3{background:#2e6b9e}.dc4{background:#7b3f8a}.dc5{background:#b85c38}
.dc6{background:#3d7a6b}.dc7{background:#8a6d2f}

/* bible chapter picker */
.bible-testament {
  display: flex; gap: 0.4rem; margin-bottom: 0.7rem; flex-wrap: wrap;
}
.testament-btn {
  font-family: 'EB Garamond', serif; font-size: 0.82rem; letter-spacing: 0.04em;
  padding: 0.3rem 0.8rem; border: 1.5px solid var(--parchment-dark); border-radius: 2px;
  background: var(--parchment); color: #888; cursor: pointer; transition: all 0.15s;
}
.testament-btn.active { background: var(--rust); border-color: var(--rust); color: #fff; }
.bible-book-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 0.35rem; max-height: 200px; overflow-y: auto;
  border: 1.5px solid var(--parchment-dark); border-radius: 3px;
  padding: 0.5rem; background: var(--parchment); margin-bottom: 0.7rem;
}
.bible-book-btn {
  font-family: 'EB Garamond', serif; font-size: 0.82rem;
  padding: 0.28rem 0.4rem; border: 1px solid var(--parchment-dark);
  border-radius: 2px; background: #fff; color: var(--ink);
  cursor: pointer; transition: all 0.15s; text-align: left; white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis;
}
.bible-book-btn:hover { border-color: var(--amber); color: var(--amber); }
.bible-book-btn.active { background: var(--amber); border-color: var(--amber); color: #fff; }
.bible-selected-info {
  background: rgba(139,58,26,0.07); border: 1px solid rgba(139,58,26,0.2);
  border-radius: 3px; padding: 0.5rem 0.8rem; font-size: 0.88rem;
  color: var(--rust); font-style: italic; margin-bottom: 0.7rem;
}
.chapter-tag {
  display: inline-block; font-size: 0.72rem; background: rgba(200,134,10,0.12);
  border: 1px solid rgba(200,134,10,0.25); color: var(--amber);
  padding: 0.08rem 0.4rem; border-radius: 2px; margin-left: 0.3rem;
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê STICKY TOP BAR ‚ïê‚ïê -->
<div class="top-bar">
  <nav>
    <div class="nav-brand"><em>üîñ</em> BookMarker</div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchPage('tracker',this)">Reading Plan</button>
      <button class="nav-tab" onclick="switchPage('library',this)">My Library</button>
    </div>
  </nav>

  <!-- STREAK always visible -->
  <div class="streak-banner">
    <div class="streak-left">
      <div class="streak-fire" id="sb-fire">üìñ</div>
      <div>
        <div class="streak-num" id="sb-num">0</div>
        <div class="streak-info">
          <span class="lbl">Day Streak</span>
          <span class="msg" id="sb-msg">Start your streak today</span>
        </div>
      </div>
    </div>
    <div class="streak-right">
      <span class="streak-logged" id="sb-logged"></span>
      <button class="btn btn-ink" onclick="logToday()">‚úì Mark Today</button>
      <button class="btn btn-ink" onclick="resetStreak()">Reset</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE: TRACKER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="page-tracker" class="page active">
<div class="page-inner">

  <!-- SHELF -->
  <div class="section-header">
    <div class="section-title">Your Books</div>
  </div>
  <div class="book-shelf" id="book-shelf">
    <button class="add-book-tab" id="add-tab-btn" onclick="toggleAddPanel()" title="Add a book">+</button>
  </div>

  <!-- ADD PANEL -->
  <div class="add-panel" id="add-panel">
    <div class="add-panel-header" onclick="toggleAddPanel()">
      <span class="add-panel-title">Add a New Book</span>
      <span class="add-panel-arrow" id="add-arrow">‚ñº</span>
    </div>
    <div class="add-panel-body" id="add-body">

      <!-- search -->
      <div style="margin-bottom:1rem">
        <div class="form-group" style="margin-bottom:0.5rem">
          <label>Search Google Books / Open Library</label>
          <div class="search-row">
            <input type="text" id="bsearch" placeholder="Title or author‚Ä¶" onkeydown="if(event.key==='Enter')searchBooks()">
            <button class="btn btn-primary" onclick="searchBooks()">Search</button>
          </div>
        </div>
        <div class="search-status" id="sstatus"></div>
        <div id="search-results"></div>
      </div>

      <!-- selected preview -->
      <div id="sel-banner" style="display:none;align-items:center;gap:0.7rem;background:rgba(200,134,10,0.07);border:1px solid rgba(200,134,10,0.2);border-radius:3px;padding:0.55rem 0.8rem;margin-bottom:0.85rem">
        <img id="sel-cover" src="" alt="" style="width:28px;height:40px;object-fit:cover;border-radius:2px;display:none">
        <div>
          <strong id="sel-title" style="font-family:'Playfair Display',serif;font-size:0.93rem;display:block"></strong>
          <small id="sel-author" style="color:#888;font-style:italic;font-size:0.82rem"></small>
        </div>
      </div>

      <!-- fields -->
      <div id="page-fields-wrap" class="fg3" style="margin-bottom:0.85rem">
        <div class="form-group" style="grid-column:1/3">
          <label>Book Title *</label>
          <input type="text" id="new-title" placeholder="Enter or select from search">
        </div>
        <div class="form-group">
          <label>Total Pages *</label>
          <input type="number" id="new-pages" placeholder="e.g. 400" min="1">
        </div>
        <div class="form-group">
          <label>Current Page</label>
          <input type="number" id="new-current" value="0" min="0">
        </div>
      </div>
      <!-- chapters mode title (shown instead of page-fields-wrap) -->
      <div id="ch-title-wrap" style="display:none;margin-bottom:0.85rem">
        <div class="form-group">
          <label>Display Title (optional override)</label>
          <input type="text" id="ch-title-override" placeholder="e.g. 'The Gospel of John' ‚Äî leave blank to use book name">
        </div>
      </div>

      <!-- goal mode -->
      <div class="form-group" style="margin-bottom:0.85rem">
        <label>How do you want to set your goal?</label>
        <div class="mode-toggle">
          <button class="active" id="mode-due-btn" onclick="setMode('due')">Finish by Date</button>
          <button id="mode-ppd-btn" onclick="setMode('ppd')">Pages Per Day</button>
          <button id="mode-ch-btn" onclick="setMode('chapters')">üìñ Bible Chapters</button>
        </div>
        <div id="mode-due-wrap">
          <div class="form-group"><label>Due Date</label><input type="date" id="new-due"></div>
        </div>
        <div id="mode-ppd-wrap" style="display:none">
          <div class="form-group"><label>Pages Per Day</label><input type="number" id="new-ppd" placeholder="e.g. 30" min="1"></div>
        </div>
        <div id="mode-ch-wrap" style="display:none">
          <p style="font-size:0.82rem;color:#aaa;font-style:italic;margin-bottom:0.6rem">Select a book of the Bible ‚Äî chapters will be used instead of pages.</p>
          <div class="bible-testament">
            <button class="testament-btn active" onclick="showTestament('ot',this)">Old Testament</button>
            <button class="testament-btn" onclick="showTestament('nt',this)">New Testament</button>
          </div>
          <div class="bible-book-grid" id="bible-book-grid"></div>
          <div class="bible-selected-info" id="bible-selected-info" style="display:none"></div>
          <div class="fg2">
            <div class="form-group">
              <label>Starting Chapter</label>
              <input type="number" id="ch-start" placeholder="1" min="1" value="1" oninput="updateBibleInfo()">
            </div>
            <div class="form-group">
              <label>Goal Mode</label>
              <div class="mode-toggle" style="margin-bottom:0">
                <button class="active" id="ch-mode-due-btn" onclick="setChapterGoalMode('due')">By Date</button>
                <button id="ch-mode-cpd-btn" onclick="setChapterGoalMode('cpd')">Ch / Day</button>
              </div>
            </div>
          </div>
          <div id="ch-due-wrap" style="margin-top:0.6rem">
            <div class="form-group"><label>Finish By</label><input type="date" id="ch-due"></div>
          </div>
          <div id="ch-cpd-wrap" style="display:none;margin-top:0.6rem">
            <div class="form-group"><label>Chapters Per Day</label><input type="number" id="ch-cpd" placeholder="e.g. 2" min="1" value="1"></div>
          </div>
        </div>
      </div>

      <div class="form-row">
        <button class="btn btn-ghost btn-sm" onclick="toggleAddPanel()">Cancel</button>
        <button class="btn btn-primary" onclick="addBook()">Add Book ‚ú¶</button>
      </div>
    </div>
  </div>

  <!-- ACTIVE BOOK DETAIL -->
  <div id="book-detail-area"></div>

  <!-- LOG SESSION -->
  <div class="card fu" id="log-card" style="display:none">
    <h2>Log a Reading Session</h2>
    <div class="log-row">
      <div class="form-group"><label>Pages Read</label><input type="number" id="log-pages" placeholder="45" min="1"></div>
      <div class="form-group"><label>Date</label><input type="date" id="log-date"></div>
      <button class="btn btn-primary" style="align-self:flex-end" onclick="logSession()">Log</button>
    </div>
  </div>

  <!-- HISTORY CHART -->
  <div class="card fu" id="chart-card" style="display:none">
    <h2>Reading History <span style="font-size:0.76rem;color:#bbb;font-family:'EB Garamond',serif;font-style:italic;font-weight:normal">(all books ¬∑ last 30 days)</span></h2>
    <div class="chart-wrap"><canvas id="hchart"></canvas></div>
    <div style="text-align:right;margin-top:0.4rem">
      <button class="btn btn-ghost btn-sm" onclick="clearHistory()">Clear History</button>
    </div>
  </div>

  <!-- COMBINED DAILY SCHEDULE -->
  <div class="card fu" id="schedule-card" style="display:none">
    <h2>Daily Reading Schedule</h2>
    <p style="font-size:0.84rem;color:#aaa;font-style:italic;margin-bottom:1rem">All active books combined. Snooze a book on any day to skip it ‚Äî pages redistribute automatically.</p>
    <div id="combined-sched"></div>
  </div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE: LIBRARY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="page-library" class="page">
<div class="page-inner">

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;flex-wrap:wrap;gap:0.8rem">
    <div style="font-family:'Playfair Display',serif;font-size:1.35rem;color:var(--parchment);font-style:italic">My Library</div>
    <button class="btn btn-primary" onclick="toggleLibAdd()">+ Add Book</button>
  </div>

  <!-- ADD (library) -->
  <div id="lib-add" style="display:none;margin-bottom:1.2rem">
    <div class="card">
      <h2>Add to Library</h2>
      <div class="fg2" style="margin-bottom:0.7rem">
        <div class="form-group"><label>Title *</label><input type="text" id="lib-title" placeholder="Book title"></div>
        <div class="form-group"><label>Author</label><input type="text" id="lib-author" placeholder="Author"></div>
        <div class="form-group"><label>Location / Shelf / Call No.</label><input type="text" id="lib-loc" placeholder="e.g. Fiction A‚ÄìF, Aisle 3"></div>
        <div class="form-group"><label>Library Due Date</label><input type="date" id="lib-due"></div>
        <div class="form-group"><label>Status</label>
          <select id="lib-status">
            <option value="unread">Want to Read</option>
            <option value="reading">Currently Reading</option>
            <option value="finished">Finished</option>
          </select>
        </div>
        <div class="form-group"><label>Notes</label><textarea id="lib-notes" placeholder="Call number, branch, anything‚Ä¶"></textarea></div>
      </div>
      <div class="form-row">
        <button class="btn btn-ghost btn-sm" onclick="toggleLibAdd()">Cancel</button>
        <button class="btn btn-primary" onclick="addLibBook()">Add to Library</button>
      </div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="lib-filters">
    <input type="text" id="lib-search" placeholder="Search‚Ä¶" oninput="renderLib()">
    <button class="filter-chip active" onclick="setFilter('all',this)">All</button>
    <button class="filter-chip" onclick="setFilter('unread',this)">Want to Read</button>
    <button class="filter-chip" onclick="setFilter('reading',this)">Reading</button>
    <button class="filter-chip" onclick="setFilter('finished',this)">Finished</button>
    <button class="filter-chip" onclick="setFilter('overdue',this)">‚ö† Overdue</button>
  </div>

  <div class="library-grid" id="lib-grid"><div class="empty-state">Your library is empty.</div></div>
</div>
</div>

<script>
// ‚ïê‚ïê CONSTANTS ‚ïê‚ïê
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const WDAYS  = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const COLORS = ['#c8860a','#8b3a1a','#4a6741','#2e6b9e','#7b3f8a','#b85c38','#3d7a6b','#8a6d2f'];
const DCLASSES = ['dc0','dc1','dc2','dc3','dc4','dc5','dc6','dc7'];

function todayStr() { return new Date().toISOString().split('T')[0]; }
function dkey(d)    { return d.toISOString().split('T')[0]; }
function pdate(s)   { return new Date(s + 'T00:00:00'); }
function ls(k,d)    { try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch(e){return d;} }
function lss(k,v)   { try{ localStorage.setItem(k,JSON.stringify(v)); }catch(e){} }

// ‚ïê‚ïê NAV ‚ïê‚ïê
function switchPage(p, btn) {
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  btn.classList.add('active');
}

// ‚ïê‚ïê STREAK ‚ïê‚ïê
function getStreak() { return ls('rr_streak',{count:0,lastDate:null}); }

function renderStreak() {
  const s = getStreak();
  const isToday = s.lastDate === todayStr();
  document.getElementById('sb-num').textContent = s.count;
  document.getElementById('sb-fire').textContent = s.count>=7?'üî•':s.count>=3?'‚ú®':'üìñ';
  const msgs = ['Start your streak today','One day ‚Äî the journey begins.','Two days strong!',
    'Three in a row. A habit is forming.','Four days of dedication.','Five days ‚Äî keep going!',
    'Six days. Almost a full week!','A full week of reading. Magnificent.'];
  document.getElementById('sb-msg').textContent = msgs[Math.min(s.count,msgs.length-1)];
  document.getElementById('sb-logged').textContent = isToday ? '‚úì logged today' : '';
}

function logToday() {
  const s = getStreak(); const today = todayStr();
  const yest = new Date(); yest.setDate(yest.getDate()-1);
  const yStr = yest.toISOString().split('T')[0];
  if (s.lastDate===today){alert('Already logged today!');return;}
  s.count = (s.lastDate===yStr) ? s.count+1 : 1;
  s.lastDate = today;
  lss('rr_streak',s); renderStreak();
}

function resetStreak() {
  if(!confirm('Reset streak to zero?'))return;
  lss('rr_streak',{count:0,lastDate:null}); renderStreak();
}

// ‚ïê‚ïê BIBLE DATA ‚ïê‚ïê
const BIBLE = {
  ot: [
    {name:'Genesis',ch:50},{name:'Exodus',ch:40},{name:'Leviticus',ch:27},
    {name:'Numbers',ch:36},{name:'Deuteronomy',ch:34},{name:'Joshua',ch:24},
    {name:'Judges',ch:21},{name:'Ruth',ch:4},{name:'1 Samuel',ch:31},
    {name:'2 Samuel',ch:24},{name:'1 Kings',ch:22},{name:'2 Kings',ch:25},
    {name:'1 Chronicles',ch:29},{name:'2 Chronicles',ch:36},{name:'Ezra',ch:10},
    {name:'Nehemiah',ch:13},{name:'Esther',ch:10},{name:'Job',ch:42},
    {name:'Psalms',ch:150},{name:'Proverbs',ch:31},{name:'Ecclesiastes',ch:12},
    {name:'Song of Solomon',ch:8},{name:'Isaiah',ch:66},{name:'Jeremiah',ch:52},
    {name:'Lamentations',ch:5},{name:'Ezekiel',ch:48},{name:'Daniel',ch:12},
    {name:'Hosea',ch:14},{name:'Joel',ch:3},{name:'Amos',ch:9},
    {name:'Obadiah',ch:1},{name:'Jonah',ch:4},{name:'Micah',ch:7},
    {name:'Nahum',ch:3},{name:'Habakkuk',ch:3},{name:'Zephaniah',ch:3},
    {name:'Haggai',ch:2},{name:'Zechariah',ch:14},{name:'Malachi',ch:4},
  ],
  nt: [
    {name:'Matthew',ch:28},{name:'Mark',ch:16},{name:'Luke',ch:24},
    {name:'John',ch:21},{name:'Acts',ch:28},{name:'Romans',ch:16},
    {name:'1 Corinthians',ch:16},{name:'2 Corinthians',ch:13},{name:'Galatians',ch:6},
    {name:'Ephesians',ch:6},{name:'Philippians',ch:4},{name:'Colossians',ch:4},
    {name:'1 Thessalonians',ch:5},{name:'2 Thessalonians',ch:3},{name:'1 Timothy',ch:6},
    {name:'2 Timothy',ch:4},{name:'Titus',ch:3},{name:'Philemon',ch:1},
    {name:'Hebrews',ch:13},{name:'James',ch:5},{name:'1 Peter',ch:5},
    {name:'2 Peter',ch:3},{name:'1 John',ch:5},{name:'2 John',ch:1},
    {name:'3 John',ch:1},{name:'Jude',ch:1},{name:'Revelation',ch:22},
  ]
};

let selectedBibleBook = null; // {name, ch, testament}
let bibleTestament = 'ot';

function renderBibleGrid(testament) {
  bibleTestament = testament;
  selectedBibleBook = null;
  document.getElementById('bible-selected-info').style.display = 'none';
  const grid = document.getElementById('bible-book-grid');
  grid.innerHTML = BIBLE[testament].map(b =>
    `<button class="bible-book-btn" onclick="selectBibleBook('${b.name}',${b.ch},'${testament}')" title="${b.ch} chapters">${b.name}</button>`
  ).join('');
}

function showTestament(t, btn) {
  document.querySelectorAll('.testament-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderBibleGrid(t);
}

function selectBibleBook(name, chapters, testament) {
  selectedBibleBook = {name, chapters, testament};
  document.querySelectorAll('.bible-book-btn').forEach(b=>{
    b.classList.toggle('active', b.textContent.trim()===name);
  });
  updateBibleInfo();
}

function updateBibleInfo() {
  if (!selectedBibleBook) return;
  const startCh = parseInt(document.getElementById('ch-start').value)||1;
  const remaining = Math.max(1, selectedBibleBook.chapters - startCh + 1);
  const info = document.getElementById('bible-selected-info');
  info.style.display = 'block';
  info.innerHTML = `<strong>${selectedBibleBook.name}</strong> ‚Äî ${selectedBibleBook.chapters} chapters total ¬∑ starting ch. ${startCh} ¬∑ <strong>${remaining}</strong> chapters remaining`;
}

// ‚ïê‚ïê BOOKS DATA ‚ïê‚ïê
let books = ls('rr_books',[]);
let activeId = books.length ? books[0].id : null;
let goalMode = 'due';
let pending = null; // pending search result

function saveBooks(){ lss('rr_books',books); }
function getBook(id){ return books.find(b=>b.id===id); }
function colorOf(b){ return COLORS[b.colorIdx % COLORS.length]; }
function dcOf(b){ return DCLASSES[b.colorIdx % DCLASSES.length]; }

// ‚ïê‚ïê SEARCH ‚ïê‚ïê
async function searchBooks() {
  const q = document.getElementById('bsearch').value.trim();
  if (!q) return;
  const st = document.getElementById('sstatus');
  const re = document.getElementById('search-results');
  st.innerHTML = '<span class="spinner"></span> Searching‚Ä¶';
  re.style.display='none'; re.innerHTML='';
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), 9000);
  try {
    const gbr = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=6&printType=books`,{signal:ctrl.signal});
    clearTimeout(t);
    if (gbr.ok) {
      const gb = await gbr.json();
      if (gb.items?.length) {
        showResults(gb.items.map(i=>({
          title:i.volumeInfo.title,
          author:(i.volumeInfo.authors||['Unknown'])[0],
          pages:i.volumeInfo.pageCount||null,
          year:i.volumeInfo.publishedDate?.slice(0,4)||null,
          cover:i.volumeInfo.imageLinks?.thumbnail?.replace('http:','https:')||null,
        })),st,re); return;
      }
    }
    const ol = await (await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(q)}&limit=6&fields=title,author_name,number_of_pages_median,cover_i,first_publish_year`)).json();
    if (ol.docs?.length) {
      showResults(ol.docs.map(b=>({
        title:b.title, author:b.author_name?.[0]||'Unknown',
        pages:b.number_of_pages_median||null, year:b.first_publish_year||null,
        cover:b.cover_i?`https://covers.openlibrary.org/b/id/${b.cover_i}-S.jpg`:null,
      })),st,re); return;
    }
    st.textContent='No results found. Enter title manually below.';
  } catch(e) {
    clearTimeout(t);
    st.innerHTML='';
    re.style.display='block';
    re.innerHTML='<div class="info-box"><strong>Search unavailable in preview.</strong> Download & open in your browser for full search. Enter title manually for now.</div>';
  }
}

function showResults(items,st,re) {
  st.textContent=`${items.length} result(s) ‚Äî click to select`;
  re.style.display='block'; re.innerHTML='';
  items.forEach(item=>{
    const d=document.createElement('div'); d.className='book-result';
    d.innerHTML=`${item.cover?`<img src="${item.cover}" onerror="this.style.display='none'" alt="">`:''}<div class="book-result-info"><strong>${item.title}</strong><small>${item.author}${item.year?' ¬∑ '+item.year:''}</small></div><div class="book-result-pp">${item.pages?item.pages+' pp.':''}</div>`;
    d.onclick=()=>selectResult(item); re.appendChild(d);
  });
}

function selectResult(item) {
  pending=item;
  document.getElementById('new-title').value=item.title;
  if(item.pages) document.getElementById('new-pages').value=item.pages;
  const b=document.getElementById('sel-banner');
  b.style.display='flex';
  document.getElementById('sel-title').textContent=item.title;
  document.getElementById('sel-author').textContent=item.author;
  const img=document.getElementById('sel-cover');
  if(item.cover){img.src=item.cover;img.style.display='block';}else{img.style.display='none';}
  document.getElementById('search-results').style.display='none';
  document.getElementById('sstatus').textContent='';
}

// ‚ïê‚ïê ADD PANEL ‚ïê‚ïê
function toggleAddPanel() {
  const body = document.getElementById('add-body');
  const arrow = document.getElementById('add-arrow');
  const open = body.classList.toggle('open');
  arrow.style.transform = open ? 'rotate(180deg)' : '';
  if (open) {
    const d=new Date(); d.setDate(d.getDate()+14);
    document.getElementById('new-due').value=d.toISOString().split('T')[0];
    document.getElementById('ch-due').value=d.toISOString().split('T')[0];
    renderBibleGrid('ot');
  }
}

function setMode(m) {
  goalMode=m;
  document.getElementById('mode-due-btn').classList.toggle('active',m==='due');
  document.getElementById('mode-ppd-btn').classList.toggle('active',m==='ppd');
  document.getElementById('mode-ch-btn').classList.toggle('active',m==='chapters');
  document.getElementById('mode-due-wrap').style.display=m==='due'?'':'none';
  document.getElementById('mode-ppd-wrap').style.display=m==='ppd'?'':'none';
  document.getElementById('mode-ch-wrap').style.display=m==='chapters'?'':'none';
  document.getElementById('page-fields-wrap').style.display=m==='chapters'?'none':'';
  document.getElementById('ch-title-wrap').style.display=m==='chapters'?'':'none';
  // hide search in chapters mode
  document.getElementById('bsearch').closest('div').parentElement.style.display=m==='chapters'?'none':'';
}

let chapterGoalMode = 'due';
function setChapterGoalMode(m) {
  chapterGoalMode = m;
  document.getElementById('ch-mode-due-btn').classList.toggle('active',m==='due');
  document.getElementById('ch-mode-cpd-btn').classList.toggle('active',m==='cpd');
  document.getElementById('ch-due-wrap').style.display=m==='due'?'':'none';
  document.getElementById('ch-cpd-wrap').style.display=m==='cpd'?'':'none';
}

// ‚ïê‚ïê ADD BOOK ‚ïê‚ïê
function addBook() {
  let book;

  if (goalMode === 'chapters') {
    // ‚îÄ‚îÄ BIBLE CHAPTERS MODE ‚îÄ‚îÄ
    if (!selectedBibleBook) { alert('Please select a book of the Bible.'); return; }
    const startCh = parseInt(document.getElementById('ch-start').value)||1;
    if (startCh > selectedBibleBook.chapters) { alert('Starting chapter exceeds total chapters.'); return; }
    const titleOverride = document.getElementById('ch-title-override').value.trim();
    const title = titleOverride || selectedBibleBook.name;
    const totalCh = selectedBibleBook.chapters;
    const currentCh = startCh - 1; // chapters completed = startCh - 1

    if (chapterGoalMode === 'due' && !document.getElementById('ch-due').value) { alert('Please enter a finish date.'); return; }
    if (chapterGoalMode === 'cpd' && !parseInt(document.getElementById('ch-cpd').value)) { alert('Please enter chapters per day.'); return; }

    book = {
      id: Date.now(), title,
      author: selectedBibleBook.testament === 'nt' ? 'New Testament' : 'Old Testament',
      cover: null, isChapterMode: true,
      bibleName: selectedBibleBook.name,
      totalPages: totalCh,   // reusing totalPages as totalChapters
      currentPage: currentCh, // reusing currentPage as currentChapter
      unit: 'ch',
      mode: chapterGoalMode === 'due' ? 'due' : 'ppd',
      dueDate: chapterGoalMode === 'due' ? document.getElementById('ch-due').value : null,
      ppd: chapterGoalMode === 'cpd' ? parseInt(document.getElementById('ch-cpd').value) : null,
      colorIdx: books.length, snoozed: {},
    };

  } else {
    // ‚îÄ‚îÄ PAGES MODE ‚îÄ‚îÄ
    const title = document.getElementById('new-title').value.trim();
    const tp = parseInt(document.getElementById('new-pages').value);
    const cp = parseInt(document.getElementById('new-current').value)||0;
    if (!title) { alert('Please enter a title.'); return; }
    if (!tp||tp<1) { alert('Please enter total pages.'); return; }
    if (goalMode==='due' && !document.getElementById('new-due').value) { alert('Please enter a due date.'); return; }
    if (goalMode==='ppd' && !parseInt(document.getElementById('new-ppd').value)) { alert('Please enter pages per day.'); return; }

    book = {
      id: Date.now(), title, author: pending?.author||'', cover: pending?.cover||null,
      isChapterMode: false, unit: 'pp',
      totalPages: tp, currentPage: cp, mode: goalMode,
      dueDate: goalMode==='due' ? document.getElementById('new-due').value : null,
      ppd: goalMode==='ppd' ? parseInt(document.getElementById('new-ppd').value) : null,
      colorIdx: books.length, snoozed: {},
    };
  }

  books.push(book); saveBooks(); activeId = book.id; pending = null; selectedBibleBook = null;

  // reset form
  ['new-title','new-pages','new-ppd','ch-title-override'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  document.getElementById('new-current').value='0';
  document.getElementById('ch-start').value='1';
  document.getElementById('sel-banner').style.display='none';
  document.getElementById('bsearch').value='';
  document.getElementById('bible-selected-info').style.display='none';

  const body = document.getElementById('add-body');
  body.classList.remove('open');
  document.getElementById('add-arrow').style.transform='';
  setMode('due'); // reset mode for next time
  renderAll();
}

function removeBook(id) {
  if(!confirm('Remove this book from your plan?'))return;
  books=books.filter(b=>b.id!==id);
  if(activeId===id) activeId=books.length?books[0].id:null;
  saveBooks(); renderAll();
}

// ‚ïê‚ïê SNOOZE (per book per day) ‚ïê‚ïê
function toggleSnooze(bookId, dk) {
  const b=getBook(bookId); if(!b)return;
  if(b.snoozed[dk]) delete b.snoozed[dk]; else b.snoozed[dk]=true;
  saveBooks(); renderAll();
}

// ‚ïê‚ïê CHECK OFF a book for a day ‚ïê‚ïê
// Marks book done for that day at its current page. Uncheck restores.
function checkBook(bookId, dk) {
  const b=getBook(bookId); if(!b)return;
  if(!b.done) b.done={};
  if(b.done[dk]!==undefined){
    // un-check
    delete b.done[dk];
  } else {
    // check: record current page as completion
    b.done[dk]=b.currentPage;
  }
  saveBooks(); renderAll();
}

// ‚ïê‚ïê CHECK OFF (mark a book done for a specific day) ‚ïê‚ïê
// book.done = { 'YYYY-MM-DD': pageReachedThatDay }
function checkBook(bookId, dk) {
  const b = getBook(bookId); if(!b) return;
  if (!b.done) b.done = {};

  if (b.done[dk] !== undefined) {
    // un-check: restore currentPage to what it was before this check
    // We do this by just removing the done marker; currentPage stays where it is
    // (user can manually fix if needed)
    delete b.done[dk];
    saveBooks(); renderAll(); return;
  }

  // Mark as done: record current page as the completion point for today
  b.done[dk] = b.currentPage;
  saveBooks(); renderAll();
}

// ‚ïê‚ïê COMPUTE SCHEDULE FOR ONE BOOK ‚ïê‚ïê
function computeSched(book, daysAhead=28) {
  const today=new Date(); today.setHours(0,0,0,0);
  let endDate;
  if(book.mode==='due') {
    endDate=pdate(book.dueDate);
  } else {
    const rem=Math.max(0,book.totalPages-book.currentPage);
    const dn=Math.ceil(rem/book.ppd)||1;
    endDate=new Date(today); endDate.setDate(today.getDate()+dn);
  }

  let ppd;
  if(book.mode==='due') {
    const totalDays=Math.max(1,Math.round((endDate-today)/86400000));
    let activeDays=0;
    for(let i=0;i<totalDays;i++){
      const d=new Date(today); d.setDate(today.getDate()+i);
      if(!book.snoozed[dkey(d)]) activeDays++;
    }
    activeDays=Math.max(1,activeDays);
    ppd=Math.ceil(Math.max(0,book.totalPages-book.currentPage)/activeDays);
  } else {
    ppd=book.ppd;
  }

  const result=[];
  let page=book.currentPage;
  const limit=Math.min(daysAhead, Math.max(1,Math.round((endDate-today)/86400000)+1));

  for(let i=0;i<limit&&page<book.totalPages;i++){
    const d=new Date(today); d.setDate(today.getDate()+i);
    const dk=dkey(d);
    const snz=!!book.snoozed[dk];
    const start=page+1;
    const end=snz?page:Math.min(page+ppd,book.totalPages);
    result.push({date:dk,pagesStart:start,pagesEnd:end,isSnoozed:snz});
    if(!snz) page=end;
  }
  return result;
}

// ‚ïê‚ïê RENDER SHELF TABS ‚ïê‚ïê
function renderShelf() {
  const shelf=document.getElementById('book-shelf');
  const addBtn=document.getElementById('add-tab-btn');
  shelf.querySelectorAll('.book-tab').forEach(t=>t.remove());
  books.forEach(b=>{
    const tab=document.createElement('button');
    tab.className='book-tab'+(b.id===activeId?' active':'');
    const shortTitle=b.title.length>17?b.title.slice(0,15)+'‚Ä¶':b.title;
    tab.innerHTML=`<span class="dot ${dcOf(b)}"></span>${shortTitle}<span class="xt" onclick="event.stopPropagation();removeBook(${b.id})">‚úï</span>`;
    tab.onclick=()=>{activeId=b.id;renderAll();};
    shelf.insertBefore(tab,addBtn);
  });
}

// ‚ïê‚ïê RENDER BOOK DETAIL ‚ïê‚ïê
function renderBookDetail() {
  const area=document.getElementById('book-detail-area');
  const lc=document.getElementById('log-card');
  const cc=document.getElementById('chart-card');
  const sc=document.getElementById('schedule-card');

  if(!books.length){
    area.innerHTML=`<div style="text-align:center;padding:3rem;color:rgba(245,237,214,0.3);font-style:italic">No books yet ‚Äî hit the + to add your first book.</div>`;
    lc.style.display=cc.style.display=sc.style.display='none'; return;
  }

  const book=getBook(activeId);
  if(!book){activeId=books[0].id;renderAll();return;}

  const isChap=book.isChapterMode;
  const unitFull=isChap?'chapter':'page';
  const unitPl=isChap?'chapters':'pages';
  const todayK=todayStr();

  const now=new Date(); now.setHours(0,0,0,0);
  const pLeft=Math.max(0,book.totalPages-book.currentPage);
  const pct=Math.round((book.currentPage/book.totalPages)*100);
  const color=colorOf(book);

  // Today's schedule entry
  const sched=computeSched(book,1);
  const todayEntry=sched.find(e=>e.date===todayK);
  const isSnoozedToday=todayEntry?.isSnoozed;
  const todayAmt=todayEntry&&!isSnoozedToday?(todayEntry.pagesEnd-todayEntry.pagesStart+1):0;
  const isDoneToday=!!(book.done&&book.done[todayK]!==undefined);

  // ‚îÄ‚îÄ Stat slot 1: always "X left" ‚îÄ‚îÄ
  const s1v=pLeft, s1l=isChap?'Chapters Left':'Pages Left';

  // ‚îÄ‚îÄ Stat slot 2: always "days left" (due) or "days to finish" (ppd) ‚îÄ‚îÄ
  let s2v, s2l;
  if(book.mode==='due'){
    s2v=Math.max(0,Math.round((pdate(book.dueDate)-now)/86400000));
    s2l='Days Left';
  } else {
    s2v=pLeft>0?Math.ceil(pLeft/Math.max(1,book.ppd)):0;
    s2l='Days to Finish';
  }

  // ‚îÄ‚îÄ Stat slot 3: always "today's target" or done checkmark ‚îÄ‚îÄ
  let s3v, s3l;
  if(isDoneToday){ s3v='‚úì'; s3l='Done Today'; }
  else if(isSnoozedToday){ s3v='‚Äî'; s3l=isChap?'Chapters Today':'Pages Today'; }
  else { s3v=todayAmt||'‚Äî'; s3l=isChap?'Chapters Today':'Pages Today'; }

  const progressLabel=isChap?`Ch. ${book.currentPage} / ${book.totalPages}`:`p.${book.currentPage} / ${book.totalPages}`;
  const goalLabel=book.mode==='due'
    ?`Due ${MONTHS[pdate(book.dueDate).getMonth()]} ${pdate(book.dueDate).getDate()}`
    :`${book.ppd} ${unitPl}/day`;
  const chTag=isChap?`<span class="chapter-tag">chapters</span>`:'';

  // ‚îÄ‚îÄ Today row ‚îÄ‚îÄ
  let todayRowHtml='';
  if(todayEntry&&!isSnoozedToday){
    const rangeLabel=isChap
      ?`Ch. ${todayEntry.pagesStart}‚Äì${todayEntry.pagesEnd}`
      :`pp. ${todayEntry.pagesStart}‚Äì${todayEntry.pagesEnd}`;
    if(isDoneToday){
      todayRowHtml=`<div class="today-row done-bg">
        <span class="tlabel">‚úì <strong>Done for today</strong> ‚Äî ${rangeLabel} complete</span>
        <button class="btn btn-ghost btn-sm" style="font-size:0.76rem;color:#aaa;padding:0.2rem 0.6rem" onclick="checkBook(${book.id},'${todayK}')">Undo</button>
      </div>`;
    } else {
      todayRowHtml=`<div class="today-row">
        <span class="tlabel">Today: <strong>${rangeLabel}</strong>&ensp;(${todayAmt} ${unitPl})</span>
        <button style="background:var(--sage);color:#fff;border:none;border-radius:3px;cursor:pointer;font-family:'EB Garamond',serif;font-size:0.82rem;padding:0.26rem 0.8rem;transition:all 0.15s" onmouseover="this.style.opacity='.85'" onmouseout="this.style.opacity='1'" onclick="checkBook(${book.id},'${todayK}')">‚úì Mark Done</button>
      </div>`;
    }
  } else if(isSnoozedToday){
    todayRowHtml=`<div class="today-row" style="opacity:0.45"><span class="tlabel">Rest day ‚Äî snoozed</span></div>`;
  }

  area.innerHTML=`
  <div class="card fu">
    <h2 style="color:${color}">${book.title}${chTag}</h2>
    <div class="book-detail">
      ${book.cover?`<img class="book-cover" src="${book.cover}" onerror="this.style.display='none'" alt="">`:
        `<div class="book-cover-ph">${isChap?'‚úù':'üìñ'}</div>`}
      <div class="book-detail-info">
        ${book.author?`<div class="book-detail-author">${isChap?'üìñ ':''}${book.author}</div>`:''}
        <div class="stats-row">
          <div class="stat-box"><span class="sv">${s1v}</span><div class="sl">${s1l}</div></div>
          <div class="stat-box"><span class="sv">${s2v}</span><div class="sl">${s2l}</div></div>
          <div class="stat-box"><span class="sv">${s3v}</span><div class="sl">${s3l}</div></div>
        </div>
        <div class="prog-label"><span>Progress</span><span>${pct}%  ¬∑  ${progressLabel}</span></div>
        <div class="prog-wrap"><div class="prog-fill" style="width:${pct}%;background:linear-gradient(to right,${color},var(--rust))"></div></div>
        ${todayRowHtml}
        <div style="margin-top:0.65rem;display:flex;gap:0.45rem;align-items:center;flex-wrap:wrap">
          <span style="font-size:0.8rem;color:#aaa;font-style:italic">${goalLabel}</span>
          <button class="btn btn-ghost btn-sm" onclick="editCurrentPage(${book.id})">Update ${unitFull}</button>
          <button class="btn btn-ghost btn-sm" style="color:var(--rust);border-color:rgba(139,58,26,0.25)" onclick="removeBook(${book.id})">Remove</button>
        </div>
      </div>
    </div>
  </div>`;

  const logLabel=document.getElementById('log-card').querySelector('label');
  if(logLabel) logLabel.textContent=isChap?'Chapters Read':'Pages Read';
  document.getElementById('log-pages').placeholder=isChap?'e.g. 2':'45';
  lc.style.display=cc.style.display=sc.style.display='block';
}

function editCurrentPage(id){
  const b=getBook(id); if(!b)return;
  const isChap=b.isChapterMode;
  const unit=isChap?'chapter':'page';
  const v=prompt(`Current ${unit} for "${b.title}" (total: ${b.totalPages}):`,b.currentPage);
  if(v===null)return;
  const n=parseInt(v);
  if(isNaN(n)||n<0||n>b.totalPages){alert('Invalid number.');return;}

  const today=todayStr();

  // Capture today's scheduled range BEFORE we change currentPage
  const schedBefore=computeSched(b,1);
  const todayEntry=schedBefore.find(e=>e.date===today);

  // Now update the page
  b.currentPage=n;

  // Mark today as done
  if(!b.done) b.done={};
  b.done[today]=n;

  // Log pages actually read to history
  // actualRead = how far they got today from where today started
  const dayStart = todayEntry && !todayEntry.isSnoozed ? todayEntry.pagesStart - 1 : b.currentPage;
  const actualRead = Math.max(0, n - dayStart);
  if(actualRead>0){
    const h=getHist();
    const ex=h.find(e=>e.date===today);
    if(ex) ex.pages=Math.max(ex.pages, actualRead);
    else { h.push({date:today, pages:actualRead}); h.sort((a,b)=>a.date.localeCompare(b.date)); }
    saveHist(h);
  }

  saveBooks(); renderAll();
}

// ‚ïê‚ïê RENDER COMBINED SCHEDULE ‚ïê‚ïê
function renderCombinedSched() {
  const container=document.getElementById('combined-sched');
  if(!books.length){container.innerHTML='';return;}

  const today=new Date(); today.setHours(0,0,0,0);
  const AHEAD=28;

  // build date‚Üíentries map
  const dayMap={};
  books.forEach(book=>{
    computeSched(book,AHEAD).forEach(e=>{
      if(!dayMap[e.date]) dayMap[e.date]=[];
      dayMap[e.date].push({book,...e});
    });
  });

  const dates=Object.keys(dayMap).sort().slice(0,AHEAD);
  if(!dates.length){
    container.innerHTML='<p style="color:#aaa;font-style:italic;font-size:0.88rem">No active books with remaining pages.</p>';
    return;
  }

  let html='';
  dates.forEach(dk=>{
    const d=pdate(dk);
    const isToday=dk===todayStr();
    const entries=dayMap[dk]||[];
    const totalPg=entries.filter(e=>!e.isSnoozed).reduce((s,e)=>s+(e.pagesEnd-e.pagesStart+1),0);
    const hasChap=entries.some(e=>e.book.isChapterMode);
    const hasPages=entries.some(e=>!e.book.isChapterMode);
    let totalLabel='all resting';
    if(totalPg>0) {
      if(hasChap&&hasPages) totalLabel=`${totalPg} items`;
      else if(hasChap) totalLabel=`${totalPg} chapter${totalPg!==1?'s':''}`;
      else totalLabel=`${totalPg} pages`;
    }

    html+=`<div class="schedule-day">
      <div class="sday-header">
        <div class="sday-date">
          ${MONTHS[d.getMonth()]} ${d.getDate()}
          <span class="dn">${WDAYS[d.getDay()]}</span>
          ${isToday?'<span class="tb">today</span>':''}
        </div>
        <div class="sday-total">${totalLabel}</div>
      </div>
      <div class="sday-books">`;

    entries.forEach(e=>{
      const cnt=e.isSnoozed?0:(e.pagesEnd-e.pagesStart+1);
      const isChap=e.book.isChapterMode;
      const isDone=!!(e.book.done&&e.book.done[dk]!==undefined);
      const rangeLabel = isChap
        ? `Ch. ${e.pagesStart}‚Äì${e.pagesEnd} <span style="color:#ccc;font-size:0.77rem">(${cnt} ch)</span>`
        : `pp. ${e.pagesStart}‚Äì${e.pagesEnd} <span style="color:#ccc;font-size:0.77rem">(${cnt})</span>`;
      const rowClass=['sbook-row', e.isSnoozed?'snz':'', isDone&&!e.isSnoozed?'done-row':''].filter(Boolean).join(' ');
      // Only show check button for today's rows (not past/future) and non-snoozed
      const showCheck=isToday&&!e.isSnoozed;
      html+=`<div class="${rowClass}">
        ${showCheck?`<button class="check-btn ${isDone?'ck':''}" onclick="checkBook(${e.book.id},'${dk}')" title="${isDone?'Mark undone':'Mark done'}">${isDone?'‚úì':''}</button>`:'<span style="width:20px;flex-shrink:0"></span>'}
        <span class="sdot" style="background:${colorOf(e.book)}"></span>
        <span class="stitle">${e.book.title}${isChap?'<span class="chapter-tag" style="font-size:0.65rem;margin-left:0.25rem">ch</span>':''}</span>
        <span class="spages">${e.isSnoozed?'‚Äî rest':isDone?`‚úì done`+` (${rangeLabel.replace(/<[^>]+>/g,'').trim()})`:rangeLabel}</span>
        <button class="snz-btn ${e.isSnoozed?'on':''}" onclick="toggleSnooze(${e.book.id},'${dk}')">
          ${e.isSnoozed?'‚Ü∫ unsnooze':'snooze'}
        </button>
      </div>`;
    });

    html+=`</div></div>`;
  });

  container.innerHTML=html;
}

// ‚ïê‚ïê HISTORY & CHART ‚ïê‚ïê
let hChart=null;
function getHist(){return ls('rr_history',[]);}
function saveHist(h){lss('rr_history',h);}

function logSession(){
  const pages=parseInt(document.getElementById('log-pages').value);
  const date=document.getElementById('log-date').value||todayStr();
  if(!pages||pages<1){alert('Enter how many pages you read.');return;}
  if(!activeId)return;
  const h=getHist();
  const ex=h.find(e=>e.date===date);
  if(ex) ex.pages+=pages; else{h.push({date,pages});h.sort((a,b)=>a.date.localeCompare(b.date));}
  saveHist(h);
  const book=getBook(activeId);
  if(book){book.currentPage=Math.min(book.totalPages,book.currentPage+pages);saveBooks();}
  document.getElementById('log-pages').value='';
  renderAll();
}

function renderChart(){
  const h=getHist();
  const ctx=document.getElementById('hchart').getContext('2d');
  const dm={};h.forEach(e=>dm[e.date]=e.pages);
  const labels=[],data=[];
  for(let i=29;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const k=dkey(d);
    labels.push(`${MONTHS[d.getMonth()]} ${d.getDate()}`);
    data.push(dm[k]||0);
  }
  if(hChart)hChart.destroy();
  hChart=new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[{data,backgroundColor:data.map(v=>v>0?'rgba(200,134,10,0.55)':'rgba(200,134,10,0.1)'),borderColor:data.map(v=>v>0?'rgba(200,134,10,0.85)':'rgba(200,134,10,0.15)'),borderWidth:1,borderRadius:2}]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`${c.parsed.y} pages`}}},
      scales:{
        x:{ticks:{font:{family:'EB Garamond',size:10},color:'#aaa',maxTicksLimit:8,maxRotation:0},grid:{color:'rgba(0,0,0,0.03)'}},
        y:{beginAtZero:true,ticks:{font:{family:'EB Garamond',size:10},color:'#aaa'},grid:{color:'rgba(0,0,0,0.04)'}}
      }
    }
  });
}

function clearHistory(){if(confirm('Clear all reading history?')){saveHist([]);renderChart();}}

// ‚ïê‚ïê RENDER ALL ‚ïê‚ïê
function renderAll(){
  renderStreak();
  renderShelf();
  renderBookDetail();
  renderChart();
  renderCombinedSched();
}

// ‚ïê‚ïê LIBRARY ‚ïê‚ïê
let libBooks=ls('rr_library',[]);
let libFilter='all';
function saveLib(){lss('rr_library',libBooks);}
const SL={unread:'Want to Read',reading:'Reading',finished:'Finished'};
const SC={unread:'badge-unread',reading:'badge-reading',finished:'badge-finished'};

function toggleLibAdd(){
  const p=document.getElementById('lib-add');
  p.style.display=p.style.display==='none'?'block':'none';
}

function setFilter(f,btn){
  libFilter=f;
  document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active'); renderLib();
}

function addLibBook(){
  const title=document.getElementById('lib-title').value.trim();
  if(!title){alert('Please enter a title.');return;}
  libBooks.unshift({
    id:Date.now(),title,
    author:document.getElementById('lib-author').value.trim(),
    location:document.getElementById('lib-loc').value.trim(),
    due:document.getElementById('lib-due').value,
    status:document.getElementById('lib-status').value,
    notes:document.getElementById('lib-notes').value.trim(),
  });
  saveLib();renderLib();
  ['lib-title','lib-author','lib-loc','lib-notes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('lib-due').value='';
  document.getElementById('lib-status').value='unread';
  document.getElementById('lib-add').style.display='none';
}

function removeLibBook(id){
  if(!confirm('Remove this book?'))return;
  libBooks=libBooks.filter(b=>b.id!==id);saveLib();renderLib();
}

function updateLibStatus(id,val){
  const b=libBooks.find(b=>b.id===id);
  if(b){b.status=val;saveLib();renderLib();}
}

function startLibEdit(id){
  const b=libBooks.find(b=>b.id===id);if(!b)return;
  const card=document.getElementById(`lc-${id}`);
  card.classList.add('editing');
  card.querySelector('.edit-section').innerHTML=`
    <div class="edit-form">
      <div class="fg2">
        <div class="form-group"><label>Title</label><input type="text" id="et-${id}" value="${b.title}"></div>
        <div class="form-group"><label>Author</label><input type="text" id="ea-${id}" value="${b.author||''}"></div>
        <div class="form-group"><label>Location</label><input type="text" id="el-${id}" value="${b.location||''}"></div>
        <div class="form-group"><label>Due Date</label><input type="date" id="ed-${id}" value="${b.due||''}"></div>
        <div class="form-group"><label>Status</label><select id="es-${id}">
          <option value="unread" ${b.status==='unread'?'selected':''}>Want to Read</option>
          <option value="reading" ${b.status==='reading'?'selected':''}>Reading</option>
          <option value="finished" ${b.status==='finished'?'selected':''}>Finished</option>
        </select></div>
        <div class="form-group"><label>Notes</label><textarea id="en-${id}">${b.notes||''}</textarea></div>
      </div>
      <div class="form-row">
        <button class="btn btn-ghost btn-sm" onclick="renderLib()">Cancel</button>
        <button class="btn btn-primary btn-sm" onclick="saveLibEdit(${id})">Save</button>
      </div>
    </div>`;
  card.querySelector('.lc-actions').style.display='none';
}

function saveLibEdit(id){
  const b=libBooks.find(b=>b.id===id);if(!b)return;
  b.title=document.getElementById(`et-${id}`).value.trim()||b.title;
  b.author=document.getElementById(`ea-${id}`).value.trim();
  b.location=document.getElementById(`el-${id}`).value.trim();
  b.due=document.getElementById(`ed-${id}`).value;
  b.status=document.getElementById(`es-${id}`).value;
  b.notes=document.getElementById(`en-${id}`).value.trim();
  saveLib();renderLib();
}

function renderLib(){
  const grid=document.getElementById('lib-grid');
  const q=(document.getElementById('lib-search')?.value||'').toLowerCase();
  const today=todayStr();
  const filtered=libBooks.filter(b=>{
    const ms=!q||b.title.toLowerCase().includes(q)||(b.author||'').toLowerCase().includes(q);
    let mf=libFilter==='all'||b.status===libFilter;
    if(libFilter==='overdue') mf=b.due&&b.due<today&&b.status!=='finished';
    return ms&&mf;
  });
  if(!filtered.length){
    grid.innerHTML=`<div class="empty-state">${!libBooks.length?'Your library is empty. Add your first book above.':'No books match this filter.'}</div>`;
    return;
  }
  grid.innerHTML=filtered.map(b=>{
    const ov=b.due&&b.due<today&&b.status!=='finished';
    const dl=b.due?Math.round((pdate(b.due)-pdate(today))/86400000):null;
    let dh='';
    if(b.due){
      const dd=pdate(b.due);
      const ds=`${MONTHS[dd.getMonth()]} ${dd.getDate()}`;
      if(ov) dh=`<div class="lc-due overdue">‚ö† Overdue ¬∑ ${ds}</div>`;
      else if(dl<=3) dh=`<div class="lc-due">‚ö° Due ${ds} (${dl}d)</div>`;
      else dh=`<div class="lc-due">üìÖ Due ${ds}</div>`;
    }
    return `<div class="library-card" id="lc-${b.id}">
      <button class="lc-delete" onclick="removeLibBook(${b.id})">‚úï</button>
      <div class="lc-title">${b.title}</div>
      ${b.author?`<div class="lc-author">by ${b.author}</div>`:''}
      <div class="lc-meta"><span class="status-badge ${SC[b.status]}">${SL[b.status]}</span></div>
      ${b.location?`<div class="lc-location">üìç ${b.location}</div>`:''}
      ${dh}
      ${b.notes?`<div class="lc-notes">${b.notes}</div>`:''}
      <div class="lc-actions">
        <button class="btn btn-ghost btn-sm" onclick="startLibEdit(${b.id})">‚úé Edit</button>
        <select class="btn btn-ghost btn-sm" style="padding:0.26rem 0.5rem;cursor:pointer" onchange="updateLibStatus(${b.id},this.value)">
          <option value="unread" ${b.status==='unread'?'selected':''}>Want to Read</option>
          <option value="reading" ${b.status==='reading'?'selected':''}>Reading</option>
          <option value="finished" ${b.status==='finished'?'selected':''}>Finished</option>
        </select>
      </div>
      <div class="edit-section"></div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê INIT ‚ïê‚ïê
document.getElementById('log-date').value=todayStr();
renderBibleGrid('ot');
renderAll();
renderLib();
</script>
</body>
</html>
